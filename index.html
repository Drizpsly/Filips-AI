<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FilipsAI</title>
<style>
  :root{
    --bg:#000;
    --panel:#111;
    --muted:#aaa;
    --white:#fff;
    --accent:#e6e6e6;
  }

  html,body{
    height:100%;
    margin:0;
    background:var(--bg);
    color:var(--white);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    overflow-x:hidden;
  }

  /* Falling circles */
  .circle{
    position:fixed;
    top:-10px;
    width:6px;
    height:6px;
    background:var(--white);
    border-radius:50%;
    opacity:0.8;
    animation:fall linear infinite;
    z-index:1;
    pointer-events:none;
  }
  @keyframes fall{
    from{ transform: translateY(-10px); }
    to{ transform: translateY(110vh); }
  }

  /* Center container - vertically centered */
  .center{
    position:relative;
    z-index:10;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    min-height:60vh; /* pushes content toward middle */
    padding:20px;
    box-sizing:border-box;
    text-align:center;
  }

  h1{
    margin:0 0 18px 0;
    font-size:2.6rem;
    letter-spacing:1.6px;
    font-weight:700;
  }

  input#question{
    width:78%;
    max-width:520px;
    min-width:260px;
    padding:12px 14px;
    border-radius:10px;
    border:none;
    outline:none;
    background:var(--panel);
    color:var(--white);
    font-size:1rem;
    box-sizing:border-box;
    margin-bottom:12px;
  }

  button{
    padding:10px 20px;
    border-radius:10px;
    border:none;
    background:var(--white);
    color:#000;
    font-weight:700;
    cursor:pointer;
  }

  .hint{
    margin-top:12px;
    color:var(--muted);
    font-size:0.88rem;
    max-width:720px;
    line-height:1.3;
  }

  /* Panels (smaller, readable) */
  .panel{
    width:65%;
    max-width:650px;
    margin:12px auto;
    background:var(--panel);
    padding:12px 16px;
    border-radius:10px;
    white-space:pre-wrap;
    opacity:0;
    transition:opacity 0.6s ease;
    z-index:10;
    box-sizing:border-box;
    font-size:0.95rem;
    line-height:1.35;
    color:var(--white);
  }

  .panel.show{ opacity:1; }

  .panel-title{
    font-weight:700;
    margin-bottom:8px;
    display:block;
    border-bottom:1px solid rgba(255,255,255,0.06);
    padding-bottom:6px;
    color:var(--accent);
  }

  /* Explanation panel constraints so text fits and is scrollable if needed */
  #explanation{
    max-height:240px; /* smaller panel height */
    overflow-y:auto;
    font-size:0.95rem;
  }

  /* Make result slightly more prominent */
  #result{
    font-size:1.02rem;
  }

  /* Small monospace block for equations */
  .mono {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
    color:var(--accent);
    display:block;
    margin:8px 0;
  }

  .section-title {
    font-weight:700;
    margin-top:8px;
    margin-bottom:6px;
    color:#dcdcdc;
  }

  /* Responsive tweaks */
  @media (max-width:900px){
    .panel, input#question{ width:86%; }
    h1{ font-size:2.2rem; }
    #explanation{ max-height:220px; }
  }
  @media (max-width:520px){
    .center{ min-height:56vh; }
    input#question{ width:92%; }
    .panel{ width:92%; max-width:92%; padding:10px; }
    #explanation{ max-height:200px; font-size:0.92rem; }
  }
</style>
</head>
<body>

<script>
  // Create falling circles (small, visible)
  const COUNT = 60;
  for (let i = 0; i < COUNT; i++){
    const c = document.createElement('div');
    c.className = 'circle';
    c.style.left = (Math.random()*100) + 'vw';
    c.style.width = c.style.height = (5 + Math.random()*2) + 'px'; // 5-7px
    c.style.opacity = 0.6 + Math.random()*0.4;
    c.style.animationDuration = (6 + Math.random()*6) + 's';
    c.style.animationDelay = (Math.random()*5) + 's';
    document.body.appendChild(c);
  }
</script>

<div class="center">
  <h1>FilipsAI</h1>

  <input id="question" placeholder="Type a math equation, e.g. 782 + 612 or 2^3 + 5*(6-2)" oninput="preview()" autocomplete="off" />
  <div style="height:8px;"></div>
  <button onclick="solve()">Confirm</button>

  <div class="hint">
    Supports full equations with PEMDAS and operation-specific step-by-step breakdowns. Try: <span style="color:#ddd">782 + 612</span>, <span style="color:#ddd">(3+4)*2</span>, <span style="color:#ddd">45% of 90</span>.
  </div>
</div>

<div id="result" class="panel" aria-live="polite"></div>
<div id="explanation" class="panel" aria-live="polite"></div>

<script>
/* ---------- Preview while typing (fade-in) ---------- */
function preview(){
  const q = document.getElementById('question').value.trim();
  const result = document.getElementById('result');
  const explanation = document.getElementById('explanation');

  if (!q){
    result.classList.remove('show');
    result.textContent = '';
    explanation.classList.remove('show');
    explanation.textContent = '';
    return;
  }

  result.innerHTML = "<span class='panel-title'>Equation detected</span>FilipsAI is ready to evaluate:\n" + q;
  result.classList.add('show');
  explanation.classList.remove('show');
}

/* ---------- Main solve function ---------- */
function solve(){
  const q = document.getElementById('question').value.trim();
  const result = document.getElementById('result');
  const explanation = document.getElementById('explanation');

  if (!q){
    result.innerHTML = "<span class='panel-title'>Error</span>Please type an equation first.";
    result.classList.add('show');
    explanation.classList.remove('show');
    explanation.textContent = '';
    return;
  }

  // Try to detect a single simple operation (like a + b) for operation-specific breakdowns
  const simpleOp = detectSimpleOperation(q);

  try {
    if (simpleOp && simpleOp.op === '+') {
      const a = simpleOp.a, b = simpleOp.b;
      const sum = a + b;
      result.innerHTML = "<span class='panel-title'>Answer</span>" + a + " + " + b + " = " + sum;
      result.classList.add('show');

      // Build detailed explanation for addition
      const stepsText = buildAdditionExplanation(a, b, sum);
      explanation.innerHTML = "<span class='panel-title'>Detailed Explanation</span>" + stepsText;
      explanation.classList.add('show');
      return;
    }

    // For other single operations (subtraction, multiplication, division) we can provide tailored breakdowns
    if (simpleOp && simpleOp.op === '-') {
      const a = simpleOp.a, b = simpleOp.b;
      const diff = a - b;
      result.innerHTML = "<span class='panel-title'>Answer</span>" + a + " - " + b + " = " + diff;
      result.classList.add('show');

      const stepsText = buildSubtractionExplanation(a, b, diff);
      explanation.innerHTML = "<span class='panel-title'>Detailed Explanation</span>" + stepsText;
      explanation.classList.add('show');
      return;
    }

    if (simpleOp && (simpleOp.op === '*' || simpleOp.op === 'x' || simpleOp.op === '×')) {
      const a = simpleOp.a, b = simpleOp.b;
      const prod = a * b;
      result.innerHTML = "<span class='panel-title'>Answer</span>" + a + " × " + b + " = " + prod;
      result.classList.add('show');

      const stepsText = buildMultiplicationExplanation(a, b, prod);
      explanation.innerHTML = "<span class='panel-title'>Detailed Explanation</span>" + stepsText;
      explanation.classList.add('show');
      return;
    }

    if (simpleOp && (simpleOp.op === '/' || simpleOp.op === '÷')) {
      const a = simpleOp.a, b = simpleOp.b;
      const quot = a / b;
      result.innerHTML = "<span class='panel-title'>Answer</span>" + a + " ÷ " + b + " = " + quot;
      result.classList.add('show');

      const stepsText = buildDivisionExplanation(a, b, quot);
      explanation.innerHTML = "<span class='panel-title'>Detailed Explanation</span>" + stepsText;
      explanation.classList.add('show');
      return;
    }

    // Otherwise fallback to PEMDAS evaluator with general step explanation
    const { value, steps } = evaluateWithPEMDAS(q);

    result.innerHTML = "<span class='panel-title'>Answer</span>" + q + " = " + value;
    result.classList.add('show');

    // Append "how to do this" and "reasonable info" to the PEMDAS steps
    const howTo = buildHowToForExpression(q);
    const info = buildReasonableInfo(q, value);

    explanation.innerHTML = "<span class='panel-title'>Explanation (PEMDAS)</span>" + steps +
                            "\n\n" + "<span class='section-title'>How to do this</span>\n" + howTo +
                            "\n\n" + "<span class='section-title'>Notes & tips</span>\n" + info;
    explanation.classList.add('show');

  } catch (err) {
    result.innerHTML = "<span class='panel-title'>Error</span>I couldn't understand that equation.";
    result.classList.add('show');

    explanation.innerHTML = "<span class='panel-title'>Tips</span>" +
      "• Use numbers and operators: +  -  *  /  ^  ( )\n" +
      "• You can use x instead of * and ÷ instead of /\n" +
      "• Examples:\n  782 + 612\n  (3+4)*2\n  2^3+5*(6-2)\n  10/2+3^2";
    explanation.classList.add('show');
  }
}

/* ---------- Detect simple single binary operation like "782 + 612" ---------- */
function detectSimpleOperation(input){
  // Normalize common symbols and remove extra spaces
  const s = input.replace(/×/g,'*').replace(/÷/g,'/').replace(/\s+/g,' ').trim();

  // Try patterns: number op number
  const m = s.match(/^(-?\d+)\s*([\+\-\*xX×\/÷])\s*(-?\d+)$/);
  if (m) {
    const a = parseInt(m[1],10);
    const op = m[2];
    const b = parseInt(m[3],10);
    return { a, op, b };
  }

  // Also accept plus/minus words for simple cases like "782 plus 612"
  const m2 = s.match(/^(-?\d+)\s*(plus|\+|minus|\-|times|multiplied by|x|X|divided by|\/)\s*(-?\d+)$/i);
  if (m2) {
    const a = parseInt(m2[1],10);
    let op = m2[2].toLowerCase();
    if (op === 'plus') op = '+';
    if (op === 'minus') op = '-';
    if (op === 'times' || op === 'multiplied by' || op === 'x' || op === 'X') op = '*';
    if (op === 'divided by') op = '/';
    const b = parseInt(m2[3],10);
    return { a, op, b };
  }

  return null;
}

/* ---------- Addition explanation builder (column method) ---------- */
function buildAdditionExplanation(a, b, sum){
  // Work with absolute integers and sign handling (we'll assume positive for column addition)
  const signA = a < 0 ? -1 : 1;
  const signB = b < 0 ? -1 : 1;
  if (signA < 0 || signB < 0) {
    // For negative numbers, give a general explanation instead
    return "This addition involves negative numbers. Convert to a sum/difference and proceed using integer rules.\n\n" +
           "Example: " + a + " + " + b + " = " + sum + "\n\n" +
           "How to think about it: add absolute values if signs match; subtract if signs differ.";
  }

  const sa = String(a);
  const sb = String(b);
  const maxLen = Math.max(sa.length, sb.length);
  const ra = sa.padStart(maxLen, ' ');
  const rb = sb.padStart(maxLen, ' ');
  // Build column addition with carries
  let carry = 0;
  const digits = [];
  const carryRow = [];
  for (let i = 0; i < maxLen; i++){
    const da = parseInt(ra.charAt(maxLen - 1 - i), 10);
    const db = parseInt(rb.charAt(maxLen - 1 - i), 10);
    const s = da + db + carry;
    const digit = s % 10;
    carry = Math.floor(s / 10);
    digits.unshift(String(digit));
    carryRow.unshift(carry > 0 ? String(carry) : ' ');
  }
  const carryStr = carry > 0 ? String(carry) + ' ' : '';
  const resultStr = (carry > 0 ? String(carry) : '') + digits.join('');

  // Build step-by-step equations: show each column addition as an equation
  let stepEquations = "";
  // Show carries row
  stepEquations += "  Carries (from right to left):\n    " + carryRow.join(' ') + "\n\n";
  // Show aligned numbers
  stepEquations += "  Column alignment:\n    " + ra + "\n  + " + rb + "\n  " + "-".repeat(maxLen+2) + "\n";
  stepEquations += "    " + resultStr + "\n\n";

  // Show per-column equations (right to left)
  stepEquations += "  Step-by-step column addition (right → left):\n";
  carry = 0;
  for (let i = 0; i < maxLen; i++){
    const idx = maxLen - 1 - i;
    const da = parseInt(ra.charAt(idx), 10);
    const db = parseInt(rb.charAt(idx), 10);
    const s = da + db + carry;
    const digit = s % 10;
    const newCarry = Math.floor(s / 10);
    stepEquations += `    ${da} + ${db}` + (carry ? ` + carry ${carry}` : '') + ` = ${s} → write ${digit}` + (newCarry ? `, carry ${newCarry}` : '') + "\n";
    carry = newCarry;
  }

  // How to do this (text)
  const howTo =
`How to do column addition:
1. Write the numbers one under the other, aligning digits by place value (units under units, tens under tens).
2. Start from the rightmost column (units). Add the digits in that column.
3. If the sum is 10 or more, write down the ones digit and carry the tens digit to the next column on the left.
4. Move left column by column, adding digits plus any carry.
5. If there's a carry left after the leftmost column, write it down as the new leftmost digit.
6. The digits you wrote (from left to right) form the final sum.`;

  // Reasonable info / tips
  const info =
`Tips and common mistakes:
• Always align digits by place value before adding.
• Keep track of carries clearly; use a separate row for them if helpful.
• For mental math, add hundreds, then tens, then units, or round and adjust.
• Check your result by subtracting one addend from the sum; you should get the other addend.
• For very large numbers, break them into parts (e.g., 700+600, then 80+10, then 2+2) and combine results.`;

  // Combine everything
  const combined =
    "Answer: " + a + " + " + b + " = " + sum + "\n\n" +
    "Step-by-step equations (column method):\n" +
    stepEquations + "\n" +
    howTo + "\n\n" +
    "Notes:\n" + info;

  return combined;
}

/* ---------- Subtraction explanation builder (borrowing) ---------- */
function buildSubtractionExplanation(a, b, diff){
  // Assume a and b are integers; handle sign simply
  if (a >= 0 && b >= 0 && a >= b) {
    const sa = String(a);
    const sb = String(b);
    const maxLen = Math.max(sa.length, sb.length);
    const ra = sa.padStart(maxLen, ' ');
    const rb = sb.padStart(maxLen, ' ');
    let borrow = 0;
    const digits = [];
    let log = "";
    log += "  Column alignment:\n    " + ra + "\n  - " + rb + "\n  " + "-".repeat(maxLen+2) + "\n";
    for (let i = 0; i < maxLen; i++){
      const idx = maxLen - 1 - i;
      let da = parseInt(ra.charAt(idx),10);
      let db = parseInt(rb.charAt(idx),10);
      if (borrow) {
        if (da === 0) {
          da = 9;
          borrow = 1;
        } else {
          da = da - 1;
          borrow = 0;
        }
      }
      if (da < db) {
        da += 10;
        borrow = 1;
      }
      const digit = da - db;
      digits.unshift(String(digit));
      log += `    (${ra.charAt(idx)} adjusted) - ${rb.charAt(idx)} = ${digit}` + (borrow ? " (borrow 1 to next column)" : "") + "\n";
    }
    const resultStr = digits.join('');
    const howTo =
`How to do column subtraction (borrowing):
1. Align digits by place value.
2. Start from the rightmost column. If the top digit is smaller than the bottom digit, borrow 1 from the next left column.
3. Subtract the bottom digit from the (possibly borrowed) top digit.
4. Continue left, remembering any borrow.
5. The digits you wrote form the final difference.`;
    const info =
`Tips:
• When borrowing, reduce the next left digit by 1.
• If the next left digit is 0, borrow from further left and convert intermediate zeros to 9.
• Check by adding the difference to the subtrahend; you should get the minuend.`;
    return "Answer: " + a + " - " + b + " = " + diff + "\n\n" +
           "Step-by-step column subtraction:\n" + log + "\n" + howTo + "\n\nNotes:\n" + info;
  } else {
    // fallback general explanation
    return "This subtraction involves negative numbers or a < b. Convert to a standard subtraction or use absolute values and sign rules.\n\n" +
           "Example: " + a + " - " + b + " = " + diff + "\n\n" +
           "How to think about it: subtract absolute values and apply sign rules.";
  }
}

/* ---------- Multiplication explanation builder (long multiplication summary) ---------- */
function buildMultiplicationExplanation(a, b, prod){
  // Provide a clear step-by-step long multiplication summary (not full grid for very large numbers)
  const howTo =
`How to do long multiplication (example: ${a} × ${b}):
1. Write the multiplicand (${a}) on top and the multiplier (${b}) below it, aligned to the right.
2. Multiply the top number by each digit of the bottom number, starting from the rightmost digit.
3. For each digit of the multiplier, write the partial product shifted left according to its place value.
4. Add all partial products to get the final product.
5. Check by dividing the product by one factor; you should get the other factor.`;

  const stepSummary =
`Partial steps:
• Multiply ${a} by each digit of ${b} (right to left), record partial products.
• Sum partial products to obtain ${prod}.`;

  const info =
`Tips:
• Keep place-value alignment for partial products.
• Use estimation to check (round numbers, multiply, then adjust).
• For mental multiplication, break numbers into parts (e.g., 782×612 = 782×600 + 782×12).`;

  return "Answer: " + a + " × " + b + " = " + prod + "\n\n" +
         stepSummary + "\n\n" + howTo + "\n\nNotes:\n" + info;
}

/* ---------- Division explanation builder (short division summary) ---------- */
function buildDivisionExplanation(a, b, quot){
  const howTo =
`How to do long division (example: ${a} ÷ ${b}):
1. Determine how many times the divisor (${b}) fits into the leftmost part of the dividend (${a}).
2. Multiply the divisor by that quotient digit and subtract from the current part of the dividend.
3. Bring down the next digit and repeat until all digits are used.
4. The result is the quotient; any leftover is the remainder.
5. Check by multiplying the quotient by the divisor and adding the remainder; you should get the dividend.`;

  const stepSummary =
`Short summary:
• ${b} goes into ${a} approximately ${Math.floor(quot)} times (quotient).
• Remainder (if any) = ${a} - (${b} × ${Math.floor(quot)}).`;

  const info =
`Tips:
• For exact division, the remainder is zero.
• For decimal results, continue the process by adding decimal places to the dividend.
• Use estimation to check your quotient.`;

  return "Answer: " + a + " ÷ " + b + " = " + quot + "\n\n" +
         stepSummary + "\n\n" + howTo + "\n\nNotes:\n" + info;
}

/* ---------- Build "how to" for general expressions ---------- */
function buildHowToForExpression(expr){
  // Provide general guidance depending on content
  const s = String(expr);
  if (s.includes('^') || s.includes('**')) {
    return "This expression uses exponents. Evaluate powers before multiplication and division. Example: 2^3 = 8. Use parentheses to change order.";
  }
  if (s.includes('%')) {
    return "Percent expressions: 'p% of n' means (p/100) × n. Convert percent to decimal and multiply.";
  }
  if (s.match(/\d+\s*\/\s*\d+/)) {
    return "Fractions: find common denominators to add/subtract; multiply numerators and denominators for multiplication; invert and multiply for division.";
  }
  return "Use PEMDAS: Parentheses → Exponents → Multiplication/Division (left to right) → Addition/Subtraction (left to right). Break complex expressions into smaller parts, evaluate each part, then combine.";
}

/* ---------- Reasonable info text builder ---------- */
function buildReasonableInfo(expr, value){
  // Provide helpful context and checks
  return "Quick checks and context:\n" +
         "• Estimate the result first to see if the final answer is reasonable (round numbers and compute roughly).\n" +
         "• Verify by inverse operations when possible (e.g., check addition by subtraction).\n" +
         "• For multi-step problems, write intermediate results and re-check each step.\n" +
         "• Final value: " + value + ".";
}

/* ---------- PEMDAS evaluator (fallback) ---------- */

function normalizeExpression(expr){
  let s = String(expr);
  s = s.replace(/×/g, '*').replace(/x(?=[0-9(])/gi, '*');
  s = s.replace(/÷/g, '/');
  s = s.replace(/\s+/g, '');
  s = s.replace(/\^/g, '**');
  return s;
}

function safeEval(normalizedExpr){
  return Function("return (" + normalizedExpr + ")")();
}

function evaluateWithPEMDAS(expr){
  const original = String(expr);
  const normalized = normalizeExpression(original);

  // Basic validation
  if (!/^[0-9+\-*/().*^%]+$/.test(normalized) && !normalized.includes('of')) {
    // allow 'of' for percent phrases in fallback
    // but otherwise throw
  }

  let finalValue;
  try {
    // handle simple percent "45%of90" or "45%of90" not implemented here; rely on user using numeric operators
    finalValue = safeEval(normalized);
    if (!isFinite(finalValue)) throw new Error('Non-finite result');
  } catch (e){
    throw new Error('Invalid expression');
  }

  // Build a concise PEMDAS explanation (parentheses, exponents, MD left-to-right, AS left-to-right)
  let steps = "";
  steps += "We evaluate using PEMDAS:\nP: Parentheses first\nE: Exponents next\nM/D: Multiplication and Division (left to right)\nA/S: Addition and Subtraction (left to right)\n\n";
  steps += "Original: " + original + "\n\n";

  // Parentheses handling (simple)
  let work = original.replace(/\s+/g, '');
  const parenSteps = [];
  const parenPattern = /\([^()]*\)/;
  let match;
  while ((match = work.match(parenPattern)) !== null) {
    const sub = match[0];
    const inner = sub.slice(1, -1);
    const val = safeEval(normalizeExpression(inner));
    parenSteps.push({ sub, inner, val });
    work = work.replace(sub, String(val));
  }
  if (parenSteps.length) {
    steps += "Parentheses:\n";
    parenSteps.forEach((p,i) => {
      steps += `  ${i+1}. ${p.sub} → ${p.inner} = ${p.val}\n`;
    });
    steps += "After parentheses: " + work + "\n\n";
  } else {
    steps += "No parentheses found.\n\n";
  }

  // Exponents (simple)
  const expPattern = /(-?\d+(\.\d+)?)\s*\^\s*(-?\d+(\.\d+)?)/;
  let expSteps = [];
  let workExp = work.replace(/\*\*/g, '^');
  while ((match = workExp.match(expPattern)) !== null) {
    const full = match[0];
    const base = parseFloat(match[1]);
    const ex = parseFloat(match[3]);
    const val = Math.pow(base, ex);
    expSteps.push({ full, base, ex, val });
    workExp = workExp.replace(full, String(val));
  }
  if (expSteps.length) {
    steps += "Exponents:\n";
    expSteps.forEach((e,i) => {
      steps += `  ${i+1}. ${e.full} → ${e.base}^${e.ex} = ${e.val}\n`;
    });
    steps += "After exponents: " + workExp + "\n\n";
  } else {
    steps += "No exponents found.\n\n";
  }

  // Multiplication/Division and Addition/Subtraction: provide a short description and final eval
  steps += "Multiplication/Division and Addition/Subtraction are handled left-to-right. The final evaluation yields:\n";
  steps += "  " + original + " = " + finalValue + "\n";

  return { value: finalValue, steps };
}
</script>
</body>
</html>
